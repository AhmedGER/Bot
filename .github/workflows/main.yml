# .github/workflows/build-mod.yml
name: Build Bridging Mod

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT }}
    
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 6.9
    
    - name: Clean everything first
      run: |
        rm -rf src/
        rm -rf build/
        rm -rf .gradle/
        rm -rf gradle/
        rm -f build.gradle
        rm -f gradle.properties
        rm -f settings.gradle
        rm -f gradlew*
    
    - name: Create project structure
      run: |
        mkdir -p src/main/java/com/example/bridging/mixin
        mkdir -p src/main/resources
        mkdir -p gradle/wrapper
    
    - name: Create BridgingMod.java
      run: |
        cat > src/main/java/com/example/bridging/BridgingMod.java << 'ENDOFFILE'
        package com.example.bridging;

        import net.fabricmc.api.ClientModInitializer;
        import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
        import net.minecraft.block.BlockState;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.item.BlockItem;
        import net.minecraft.item.ItemStack;
        import net.minecraft.util.Hand;
        import net.minecraft.util.hit.BlockHitResult;
        import net.minecraft.util.math.BlockPos;
        import net.minecraft.util.math.Direction;
        import net.minecraft.util.math.Vec3d;

        public class BridgingMod implements ClientModInitializer {
            
            public static final String MOD_ID = "bridging";
            private static boolean wasPressingBack = false;
            
            @Override
            public void onInitializeClient() {
                System.out.println("[Bridging Mod] Loaded! Walk backwards to auto-place blocks!");
                
                ClientTickEvents.END_CLIENT_TICK.register(client -> {
                    if (client.player != null && client.world != null) {
                        handleBridging(client, client.player);
                    }
                });
            }
            
            private void handleBridging(MinecraftClient client, ClientPlayerEntity player) {
                boolean pressingBack = client.options.keyBack.isPressed();
                
                if (!pressingBack) {
                    wasPressingBack = false;
                    return;
                }
                
                ItemStack mainHand = player.getMainHandStack();
                if (!(mainHand.getItem() instanceof BlockItem)) {
                    return;
                }
                
                BlockPos belowPos = player.getBlockPos().down();
                BlockState belowState = client.world.getBlockState(belowPos);
                
                if (!belowState.isAir()) {
                    wasPressingBack = true;
                    return;
                }
                
                if (wasPressingBack) {
                    return;
                }
                
                Vec3d hitVec = Vec3d.ofCenter(belowPos).add(0, 0.5, 0);
                BlockHitResult hitResult = new BlockHitResult(
                    hitVec,
                    Direction.UP,
                    belowPos,
                    false
                );
                
                if (client.interactionManager != null) {
                    client.interactionManager.interactBlock(
                        player,
                        client.world,
                        Hand.MAIN_HAND,
                        hitResult
                    );
                }
                
                wasPressingBack = true;
            }
        }
        ENDOFFILE
    
    - name: Create fabric.mod.json
      run: |
        cat > src/main/resources/fabric.mod.json << 'ENDOFFILE'
        {
          "schemaVersion": 1,
          "id": "bridging",
          "version": "1.0.0",
          "name": "Bridging Mod",
          "description": "Auto-place blocks below you when walking backwards",
          "authors": ["AutoBuilder"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.example.bridging.BridgingMod"]
          },
          "depends": {
            "fabricloader": ">=0.11.0",
            "fabric": "*",
            "minecraft": "1.16.5"
          }
        }
        ENDOFFILE
    
    - name: Create build.gradle
      run: |
        cat > build.gradle << 'ENDOFFILE'
        plugins {
            id 'fabric-loom' version '0.7-SNAPSHOT'
            id 'maven-publish'
        }

        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8

        archivesBaseName = "bridging-mod"
        version = "1.0.0"
        group = "com.example"

        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content {
                    includeGroup "curse.maven"
                }
            }
        }

        dependencies {
            minecraft "com.mojang:minecraft:1.16.5"
            mappings "net.fabricmc:yarn:1.16.5+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.11.3"
            modImplementation "curse.maven:fabric-api-306612:3516413"
        }

        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }

        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
        }

        java {
            withSourcesJar()
        }

        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        ENDOFFILE
    
    - name: Create gradle.properties
      run: |
        cat > gradle.properties << 'ENDOFFILE'
        org.gradle.jvmargs=-Xmx2G
        ENDOFFILE
    
    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'ENDOFFILE'
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        
        rootProject.name = 'bridging-mod'
        ENDOFFILE
    
    - name: Create .gitignore
      run: |
        cat > .gitignore << 'ENDOFFILE'
        .gradle/
        build/
        out/
        .idea/
        *.iml
        .vscode/
        run/
        ENDOFFILE
    
    - name: Create Gradle Wrapper files
      run: gradle wrapper --gradle-version 6.9
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: bridging-mod-v1.0.0
        path: build/libs/*.jar
